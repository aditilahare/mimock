name: Mimock Bundle App Pipeline

on: [workflow_dispatch]

jobs:
  bundle-app:
    name: Bundle spring-boot app with UI
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Build Mimock app
        run: |
          make bundle-app

      - name: Build platform bundles
        run: |
          cp -p ./mimock-backend/target/mimock-${{ secrets.MIMOCK_CURRENT_VERSION }}.jar ./installation/lib/mimock.jar

          cd ./installation
          zip -r mimock-${{ secrets.MIMOCK_CURRENT_VERSION }}.zip lib/*
          cd .. && mv ./installation/mimock-${{ secrets.MIMOCK_CURRENT_VERSION }}.zip .
          zip -ju mimock-${{ secrets.MIMOCK_CURRENT_VERSION }}.zip installation/*.bat installation/mimock.properties installation/psql_setup.sql

          tar czf mimock-${{ secrets.MIMOCK_CURRENT_VERSION }}.tar.gz --directory=installation lib start mimock.properties setup_database psql_setup.sql

      - name: Publish JAR
        uses: actions/upload-artifact@v2
        with:
          name: mimock-${{ secrets.MIMOCK_CURRENT_VERSION }}-jar.zip
          path: |
            ./mimock-backend/target/mimock-${{ secrets.MIMOCK_CURRENT_VERSION }}.jar

      - name: Publish Linux Bundle
        uses: actions/upload-artifact@v2
        with:
          name: mimock-${{ secrets.MIMOCK_CURRENT_VERSION }}.tar.gz
          path: |
            mimock-${{ secrets.MIMOCK_CURRENT_VERSION }}.tar.gz

      - name: Publish Windows Bundle
        uses: actions/upload-artifact@v2
        with:
          name: mimock-${{ secrets.MIMOCK_CURRENT_VERSION }}.zip
          path: |
            mimock-${{ secrets.MIMOCK_CURRENT_VERSION }}.zip

      - name: Build mimock docker image
        run: |
          docker build -t mimock-backend:${{ github.sha }} . -f ./Dockerfile.min && echo "Docker image build validated"
          docker system prune -f && docker image prune --all -f
